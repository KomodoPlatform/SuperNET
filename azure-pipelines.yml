# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

variables:
  COMMIT_HASH: git rev-parse --short HEAD

trigger:
  - azure-pipelines

pool: Default

steps:
  - checkout: self  # self represents the repo where the initial Pipelines YAML file was found
    clean: false # don't clean up to use previously built dependencies
  - script: |
      echo Add other tasks to build, test, and deploy your project.
      echo See https://aka.ms/yaml
    displayName: 'Run a multi-line script'
  - script: |
      export PATH=$PATH:/root/.cargo/bin
      cargo build -vv
      mv target/debug/mm2 target/debug/mm2-$(COMMIT_HASH)-$(Agent.OS)
    displayName: 'Build MM2'
  - script: |
      export PATH=$PATH:/root/.cargo/bin
      cargo test -- --nocapture
    displayName: 'Test MM2'
  # Copy Files Over SSH
  # Copy files or build artifacts to a remote machine over SSH
  # https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/copy-files-over-ssh?view=vsts
  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: nightly_build_server
      sourceFolder: 'target/debug' # Optional
      contents: mm2-$(COMMIT_HASH)-$(Agent.OS)
      targetFolder: "uploads/$(Build.SourceBranchName)" # Optional
      #cleanTargetFolder: false # Optional
      #overwrite: true # Optional
      #failOnEmptySource: false # Optional
      #flattenFolders: false # Optional
    displayName: 'Upload nightly'
